<!DOCTYPE html>
<html>
<head>
  <title>LuaWiki Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/styles/default.min.css">
  <link rel="stylesheet" type="text/css" href="/wiki.css">
<style>
body {
  background: #eee;
  margin: 0;
}
h1 {
  margin: 0 1em;
}
.editor {
  display: flex;
  flex-direction: row;
  width: 100%;
  height: calc(100vh - 100px);
}
.panel {
  background: #fff;
}
.gutter {
  background-color: #eee;
  background-repeat: no-repeat;
  background-position: 50%;
}

.gutter.gutter-horizontal {
  background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
  cursor: col-resize;
}
#source-editor {
  height: 100%;
}
#viewer-panel {
  padding: 0 2em;
  overflow: auto;
}
</style>
</head>
<body>
  <button style="float: right" onclick="showPreview()">Preview</button>
  <h1>LUAWIKI EDITOR</h1>
  <div class="editor">
    <div id="source-panel" class="panel">
      <div id="source-editor"></div>
    </div>
    <div id="viewer-panel" class="panel"></div>
  </div>

<script type="module">
import Split from '/split.js'
Split(['#source-panel', '#viewer-panel'], {
  onDragEnd: function() {
    if (editor) {
      editor.resize();
    }
  }
});
</script>

<script src="/simplequery.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/mhchem.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/highlight.min.js"></script>
<script src="/zh_convert.js"></script>
<script src="/wiki.js"></script>

<script src="ace-lw/ace.js"></script>
<script>
var editor = ace.edit("source-editor", {
  mode: "ace/mode/mediawiki",
  wrap: true
});
editor.setTheme("ace/theme/behave");
editor.setOption("showPrintMargin", false);
editor.setOption("wrapMethod", "text");
editor.setHighlightActiveLine(false);
editor.commands.addCommand({
  name: 'bold',
  bindKey: {win: 'Ctrl-B',  mac: 'Command-B'},
  exec: function(editor) {
    let selectedText = editor.session.getTextRange(editor.getSelectionRange());
    if (selectedText && selectedText.indexOf('\n') < 0) {
      editor.insert("'''" + selectedText + "'''");
    }
  }
});
editor.commands.addCommand({
  name: 'italic',
  bindKey: {win: 'Ctrl-I',  mac: 'Command-I'},
  exec: function(editor) {
    let selectedText = editor.session.getTextRange(editor.getSelectionRange());
    if (selectedText && selectedText.indexOf('\n') < 0) {
      editor.insert("''" + selectedText + "''");
    }
  }
});

function buildFormData(data) {
  const formData = new FormData();
  for (const key in data) {
    formData.append(key, data[key]);
  }
  return formData;
}

function showPreview() {
  fetch('/preview/test', {
    method: 'POST',
    body: buildFormData({
      content: editor.getValue()
    })
  }).then(res => res.json())
  .then(data => {
    document.getElementById('viewer-panel').innerHTML = doMwConvert(data.result);
    buildRef();
    buildMath();
    buildHighlight();
  });
}

function realFoldAll(foldingStartMarker, foldingStopMarker) {
  if (!foldingStartMarker || !foldingStopMarker) return;
  let row = 0;
  let endRow = editor.session.getLength();
  
  let line = null;
  
  function getFoldWidgetRange(offset) {
    let match = line.match(foldingStartMarker);
    if (match) {
      var rObj = { startRow: row, startColumn: match.index + offset };
      let newStart = match.index + match[0].length;
      let sameLine = line.substring(newStart);
      match = sameLine.match(foldingStopMarker);
      if (match) {
          match.index += newStart + offset;
      } else {
          while (++row < endRow) {
              line = editor.session.getLine(row);
              match = line.match(foldingStopMarker);
              if (match || row - rObj.startRow === 10) break;
          }
      }

      if (match) {
          return new ace.Range(rObj.startRow, rObj.startColumn, row, match.index + match[0].length);
      }
    }
  }
  
  line = editor.session.getLine(row);
  let offset = 0
  while (row < endRow) {
    let range = getFoldWidgetRange(offset);
    if (range) {
      range.collapseChildren = 1;
      editor.session.addFold('...', range);
      let new_offset = range.end.column;
      if (new_offset === offset) {
        console.log(line);
        break;
      }
      line = line.substring(new_offset - offset);
      offset = new_offset;
    } else {
      line = editor.session.getLine(++row);
      offset = 0;
    }
  }
}

function foldRef() {
  realFoldAll(/\<ref(?:\>| [^\/]*?\>)/, /\<\/ref\>/);
  realFoldAll(/\<ref [^\/>]*\//, /\>/);
  realFoldAll(/{{(?:r[|]|sfn|efn|备注)/, /}}/);
}

let changed = false;
editor.session.on('change', function(delta) {
  changed = true;
});

setInterval(() => {
  if (changed) {
    showPreview();
    changed = false;
  }
}, 2000);
</script>

</body>
</html>